<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SkillSwap - Messages</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', system-ui, sans-serif;
    }

    body {
      background-color: #f5f7fa;
      color: #333;
      min-height: 100vh;
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
    }

    /* Header - Modern Clean Design */
    .header {
      background: white;
      padding: 18px 40px;
      border-bottom: 2px solid #4a6cf7;
      box-shadow: 0 4px 15px rgba(74, 108, 247, 0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .logo-icon {
      width: 40px;
      height: 40px;
      background: linear-gradient(135deg, #4a6cf7, #6a8eff);
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 1.2rem;
    }

    .logo-text {
      font-size: 1.6rem;
      font-weight: 700;
      color: #4a6cf7;
      letter-spacing: -0.5px;
    }

    .user-profile {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .user-avatar {
      width: 45px;
      height: 45px;
      border-radius: 50%;
      background: linear-gradient(135deg, #4a6cf7, #6a8eff);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      color: white;
      font-size: 1.2rem;
      box-shadow: 0 4px 10px rgba(74, 108, 247, 0.3);
    }

    .user-info h3 {
      font-size: 1rem;
      font-weight: 600;
      color: #333;
    }

    .user-info p {
      font-size: 0.85rem;
      color: #666;
    }

    .back-btn {
      background: linear-gradient(135deg, #4a6cf7, #6a8eff);
      border: none;
      color: white;
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.9rem;
      font-weight: 600;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 8px;
      box-shadow: 0 4px 10px rgba(74, 108, 247, 0.3);
    }

    .back-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 15px rgba(74, 108, 247, 0.4);
    }

    /* Messages Container */
    .messages-container {
      max-width: 1200px;
      margin: 30px auto;
      padding: 0 20px;
      display: grid;
      grid-template-columns: 350px 1fr;
      gap: 25px;
      height: calc(100vh - 140px);
    }

    /* Conversations Sidebar */
    .conversations-sidebar {
      background: white;
      border-radius: 20px;
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.06);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .conversations-header {
      padding: 25px;
      border-bottom: 2px solid rgba(74, 108, 247, 0.1);
    }

    .conversations-header h2 {
      font-size: 1.6rem;
      color: #333;
      font-weight: 600;
      margin-bottom: 15px;
    }

    .search-box {
      position: relative;
      margin-bottom: 15px;
    }

    .search-box input {
      width: 100%;
      padding: 12px 45px 12px 15px;
      border: 2px solid rgba(74, 108, 247, 0.2);
      border-radius: 10px;
      font-size: 0.95rem;
      transition: all 0.3s ease;
      background: rgba(74, 108, 247, 0.03);
    }

    .search-box input:focus {
      outline: none;
      border-color: #4a6cf7;
      box-shadow: 0 0 0 3px rgba(74, 108, 247, 0.1);
    }

    .search-box i {
      position: absolute;
      right: 15px;
      top: 50%;
      transform: translateY(-50%);
      color: #4a6cf7;
    }

    .new-message-btn {
      background: linear-gradient(135deg, #4a6cf7, #6a8eff);
      border: none;
      color: white;
      padding: 12px 20px;
      border-radius: 10px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      width: 100%;
      box-shadow: 0 4px 15px rgba(74, 108, 247, 0.3);
    }

    .new-message-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(74, 108, 247, 0.4);
    }

    .conversations-list {
      flex: 1;
      overflow-y: auto;
      padding: 0;
    }

    .conversation-item {
      display: flex;
      align-items: center;
      padding: 20px;
      border-bottom: 1px solid rgba(74, 108, 247, 0.1);
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
    }

    .conversation-item:hover {
      background: rgba(74, 108, 247, 0.03);
    }

    .conversation-item.active {
      background: linear-gradient(135deg, rgba(74, 108, 247, 0.08), rgba(74, 108, 247, 0.03));
      border-left: 4px solid #4a6cf7;
    }

    .conversation-avatar {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background: linear-gradient(135deg, #4a6cf7, #6a8eff);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      color: white;
      font-size: 1.2rem;
      margin-right: 15px;
    }

    .conversation-info {
      flex: 1;
    }

    .conversation-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 5px;
    }

    .conversation-name {
      font-weight: 600;
      color: #333;
      font-size: 1rem;
    }

    .conversation-time {
      font-size: 0.8rem;
      color: #666;
    }

    .conversation-preview {
      font-size: 0.9rem;
      color: #666;
      display: -webkit-box;
      -webkit-line-clamp: 1;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .unread-badge {
      background: linear-gradient(135deg, #ff6b6b, #ff8e8e);
      color: white;
      font-size: 0.7rem;
      font-weight: 600;
      padding: 2px 8px;
      border-radius: 10px;
      min-width: 20px;
      text-align: center;
    }

    /* Chat Area */
    .chat-area {
      background: white;
      border-radius: 20px;
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.06);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .chat-header {
      padding: 25px;
      border-bottom: 2px solid rgba(74, 108, 247, 0.1);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .chat-user-info {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .chat-user-avatar {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background: linear-gradient(135deg, #4a6cf7, #6a8eff);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      color: white;
      font-size: 1.2rem;
    }

    .chat-user-details h3 {
      font-size: 1.2rem;
      color: #333;
      font-weight: 600;
      margin-bottom: 5px;
    }

    .chat-user-details p {
      font-size: 0.9rem;
      color: #666;
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .online-status {
      width: 8px;
      height: 8px;
      background: #4CAF50;
      border-radius: 50%;
      display: inline-block;
    }

    .chat-actions {
      display: flex;
      gap: 10px;
    }

    .chat-action-btn {
      width: 40px;
      height: 40px;
      border-radius: 10px;
      border: none;
      background: rgba(74, 108, 247, 0.08);
      color: #4a6cf7;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .chat-action-btn:hover {
      background: rgba(74, 108, 247, 0.15);
      transform: translateY(-2px);
    }

    .messages-container-inner {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
      background: linear-gradient(135deg, rgba(74, 108, 247, 0.02), rgba(74, 108, 247, 0.01));
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    .message-date {
      text-align: center;
      margin: 15px 0;
      color: #666;
      font-size: 0.85rem;
      font-weight: 500;
    }

    .message {
      max-width: 70%;
      padding: 15px;
      border-radius: 15px;
      position: relative;
      animation: fadeIn 0.3s ease-out;
    }

    .message.sent {
      align-self: flex-end;
      background: linear-gradient(135deg, #4a6cf7, #6a8eff);
      color: white;
      border-bottom-right-radius: 5px;
    }

    .message.received {
      align-self: flex-start;
      background: white;
      color: #333;
      border-bottom-left-radius: 5px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }

    .message-content {
      font-size: 0.95rem;
      line-height: 1.5;
    }

    .message-time {
      font-size: 0.75rem;
      opacity: 0.8;
      text-align: right;
      margin-top: 5px;
    }

    .message-input-area {
      padding: 20px;
      border-top: 2px solid rgba(74, 108, 247, 0.1);
      background: white;
    }

    .message-input-wrapper {
      display: flex;
      gap: 15px;
      align-items: center;
    }

    .message-input {
      flex: 1;
      padding: 15px 20px;
      border: 2px solid rgba(74, 108, 247, 0.2);
      border-radius: 15px;
      font-size: 0.95rem;
      transition: all 0.3s ease;
      background: rgba(74, 108, 247, 0.03);
    }

    .message-input:focus {
      outline: none;
      border-color: #4a6cf7;
      box-shadow: 0 0 0 3px rgba(74, 108, 247, 0.1);
    }

    .send-btn {
      width: 50px;
      height: 50px;
      border-radius: 15px;
      background: linear-gradient(135deg, #4a6cf7, #6a8eff);
      border: none;
      color: white;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 15px rgba(74, 108, 247, 0.3);
    }

    .send-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(74, 108, 247, 0.4);
    }

    .attachment-btn {
      width: 50px;
      height: 50px;
      border-radius: 15px;
      background: rgba(74, 108, 247, 0.08);
      border: none;
      color: #4a6cf7;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .attachment-btn:hover {
      background: rgba(74, 108, 247, 0.15);
    }

    /* No Conversation Selected */
    .no-conversation {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 40px;
      text-align: center;
      color: #666;
    }

    .no-conversation i {
      font-size: 4rem;
      color: rgba(74, 108, 247, 0.2);
      margin-bottom: 20px;
    }

    .no-conversation h3 {
      font-size: 1.5rem;
      color: #333;
      margin-bottom: 10px;
      font-weight: 600;
    }

    .no-conversation p {
      font-size: 1rem;
      max-width: 400px;
      line-height: 1.6;
    }

    /* Footer */
    .footer {
      text-align: center;
      padding: 25px;
      color: #666;
      font-size: 0.95rem;
      border-top: 1px solid rgba(74, 108, 247, 0.1);
      margin-top: 40px;
      background: white;
    }

    /* Animations */
    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateX(-10px);
      }

      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    /* Responsive Design */
    @media (max-width: 1024px) {
      .messages-container {
        grid-template-columns: 300px 1fr;
      }
    }

    @media (max-width: 768px) {
      .header {
        padding: 15px;
        flex-direction: column;
        gap: 15px;
        text-align: center;
      }

      .messages-container {
        grid-template-columns: 1fr;
        height: auto;
        padding: 15px;
      }

      .conversations-sidebar {
        height: 500px;
      }

      .chat-area {
        display: none;
      }

      .chat-area.active {
        display: flex;
        height: 600px;
      }

      .user-profile {
        flex-direction: column;
        text-align: center;
      }

      .logo-text {
        font-size: 1.4rem;
      }
    }

    /* Scrollbar Styling */
    ::-webkit-scrollbar {
      width: 6px;
    }

    ::-webkit-scrollbar-track {
      background: rgba(74, 108, 247, 0.05);
      border-radius: 10px;
    }

    ::-webkit-scrollbar-thumb {
      background: rgba(74, 108, 247, 0.2);
      border-radius: 10px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: rgba(74, 108, 247, 0.3);
    }
  </style>
</head>

<body>
  <!-- Header -->
  <header class="header">
    <div class="logo">
      <div class="logo-icon">
        <i class="fas fa-comments"></i>
      </div>
      <div class="logo-text">SkillSwap Messages</div>
    </div>

    <div class="user-profile">
      <div class="user-avatar" id="userAvatar">C</div>
      <div class="user-info">
        <h3 id="userName">Chaitu</h3>
        <p id="userEmail">Online</p>
      </div>
      <button class="back-btn" onclick="goBack()">
        <i class="fas fa-arrow-left"></i> Back to Dashboard
      </button>
    </div>
  </header>

  <!-- Messages Container -->
  <div class="messages-container">
    <!-- Conversations Sidebar -->
    <div class="conversations-sidebar">
      <div class="conversations-header">
        <h2>Messages</h2>
        <div class="search-box">
          <input type="text" placeholder="Search conversations..." id="searchInput">
          <i class="fas fa-search"></i>
        </div>
        <button class="new-message-btn" onclick="newMessage()">
          <i class="fas fa-plus"></i> New Message
        </button>
      </div>

      <div class="conversations-list" id="conversationsList">
        <!-- Conversations will be populated by JavaScript -->
      </div>
    </div>

    <!-- Chat Area -->
    <div class="chat-area" id="chatArea">
      <div class="chat-header">
        <div class="chat-user-info" id="currentChatUser">
          <div class="chat-user-avatar">S</div>
          <div class="chat-user-details">
            <h3>Select a conversation</h3>
            <p>Start chatting with your peers</p>
          </div>
        </div>
        <div class="chat-actions">
          <!-- UPDATED: Video call button redirects to videocall.html -->
          <button class="chat-action-btn" onclick="videoCall()">
            <i class="fas fa-video"></i>
          </button>
          <button class="chat-action-btn" onclick="audioCall()">
            <i class="fas fa-phone"></i>
          </button>
          <button class="chat-action-btn" onclick="viewProfile()">
            <i class="fas fa-user"></i>
          </button>
        </div>
      </div>

      <div class="messages-container-inner" id="messagesContainer">
        <div class="no-conversation">
          <i class="fas fa-comments"></i>
          <h3>No Conversation Selected</h3>
          <p>Select a conversation from the sidebar to start messaging or create a new conversation.</p>
          <button class="new-message-btn" style="margin-top: 20px; width: auto;" onclick="newMessage()">
            <i class="fas fa-plus"></i> Start New Conversation
          </button>
        </div>
      </div>

      <div class="message-input-area">
        <div class="message-input-wrapper">
          <button class="attachment-btn" onclick="attachFile()">
            <i class="fas fa-paperclip"></i>
          </button>
          <input type="text" class="message-input" placeholder="Type your message here..." id="messageInput"
            onkeypress="handleKeyPress(event)">
          <button class="send-btn" onclick="sendMessage()">
            <i class="fas fa-paper-plane"></i>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <footer class="footer">
    <p>SkillSwap Messages © 2024 | Secure and Real-time Communication</p>
  </footer>

  <script>


    // Sample conversations data
    const conversations = [
      {
        id: 'sam',
        name: 'Sam Wilson',
        avatar: 'S',
        lastMessage: 'Hey! Are we still meeting for the Java session tomorrow?',
        time: '2:30 PM',
        unread: 2,
        online: true,
        subject: 'Java Programming'
      },
      {
        id: 'alex',
        name: 'Alex Johnson',
        avatar: 'A',
        lastMessage: 'Thanks for the Python notes! They were super helpful.',
        time: 'Yesterday',
        unread: 0,
        online: false,
        subject: 'Python Basics'
      },
      {
        id: 'maya',
        name: 'Maya Sharma',
        avatar: 'M',
        lastMessage: 'Can you help me with the physics problem?',
        time: '2 days ago',
        unread: 1,
        online: true,
        subject: 'Physics'
      },
      {
        id: 'ravi',
        name: 'Ravi Kumar',
        avatar: 'R',
        lastMessage: 'Let me know when you\'re free for the math revision.',
        time: '3 days ago',
        unread: 0,
        online: false,
        subject: 'Mathematics'
      },
      {
        id: 'lisa',
        name: 'Lisa Chen',
        avatar: 'L',
        lastMessage: 'Great session today! Thanks for the web dev tips.',
        time: '1 week ago',
        unread: 0,
        online: true,
        subject: 'Web Development'
      }
    ];

    // Sample messages data
    const messagesData = {
      'sam': [
        { type: 'received', content: 'Hi Chaitu! Are we still meeting for the Java session tomorrow?', time: '2:30 PM' },
        { type: 'sent', content: 'Yes, absolutely! 6 PM as planned.', time: '2:32 PM' },
        { type: 'received', content: 'Perfect! I\'ll prepare the OOP concepts we discussed.', time: '2:33 PM' },
        { type: 'sent', content: 'Great! I\'ll bring some practice problems on inheritance and polymorphism.', time: '2:35 PM' }
      ],
      'alex': [
        { type: 'received', content: 'Thanks for the Python notes! They were super helpful for my exam preparation.', time: 'Yesterday' },
        { type: 'sent', content: 'Glad they helped! Let me know if you need anything else.', time: 'Yesterday' },
        { type: 'received', content: 'Could you explain list comprehensions once more?', time: 'Yesterday' }
      ],
      'maya': [
        { type: 'received', content: 'Hi! Can you help me with the physics problem from chapter 5?', time: '2 days ago' },
        { type: 'sent', content: 'Sure, which problem number?', time: '2 days ago' }
      ],
      'ravi': [
        { type: 'received', content: 'Let me know when you\'re free for the math revision session.', time: '3 days ago' },
        { type: 'sent', content: 'How about Friday evening?', time: '3 days ago' }
      ],
      'lisa': [
        { type: 'received', content: 'Great session today! Thanks for the web dev tips.', time: '1 week ago' },
        { type: 'sent', content: 'You\'re welcome! Your React questions were really good.', time: '1 week ago' }
      ]
    };

    // Current active conversation
    let activeConversation = null;

    // Load conversations into sidebar
    async function loadConversations(render = true) {
      const conversationsList = document.getElementById('conversationsList');
      const currentUserId = localStorage.getItem('skillSwapUserId');
      if (!currentUserId) return;

      try {
        // Fetch real conversations from database
        const response = await fetch(`/api/conversations/${currentUserId}`);

        if (response.ok) {
          const dbConversations = await response.json();

          // Convert to our format
          dbConversations.forEach(conv => {
            const realId = `real_${conv.other_user_id}`;
            const existing = conversations.find(c => c.id === realId);

            if (existing) {
              // Update existing conversation info
              existing.lastMessage = conv.last_message || existing.lastMessage;
              existing.time = conv.last_message_time ? new Date(conv.last_message_time).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : existing.time;
            } else {
              // Add new conversation
              conversations.push({
                id: realId,
                name: conv.other_user_name,
                avatar: conv.other_user_name.charAt(0).toUpperCase(),
                lastMessage: conv.last_message || 'No messages yet',
                time: conv.last_message_time ? new Date(conv.last_message_time).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : 'Now',
                unread: 0,
                online: false,
                subject: 'Community Member'
              });
            }
          });
        }
      } catch (e) {
        console.error('Error loading conversations:', e);
      }

      if (render) {
        renderConversations();
      }
    }

    // Helper to render the sidebar list
    function renderConversations() {
      const conversationsList = document.getElementById('conversationsList');
      const searchTerm = (document.getElementById('searchInput')?.value || '').toLowerCase();
      conversationsList.innerHTML = '';

      conversations.forEach(conversation => {
        // Filter by search if active
        if (searchTerm && !(conversation.name.toLowerCase().includes(searchTerm) || conversation.lastMessage.toLowerCase().includes(searchTerm))) {
          return;
        }

        const conversationItem = document.createElement('div');
        conversationItem.className = `conversation-item ${activeConversation === conversation.id ? 'active' : ''}`;
        conversationItem.dataset.id = conversation.id;
        conversationItem.onclick = () => selectConversation(conversation.id);

        conversationItem.innerHTML = `
          <div class="conversation-avatar">${conversation.avatar}</div>
          <div class="conversation-info">
            <div class="conversation-header">
              <span class="conversation-name">${conversation.name}</span>
              <span class="conversation-time">${conversation.time}</span>
            </div>
            <div class="conversation-preview">${conversation.lastMessage}</div>
          </div>
          ${conversation.unread > 0 ? `<div class="unread-badge">${conversation.unread}</div>` : ''}
        `;

        conversationsList.appendChild(conversationItem);
      });
    }

    // Select a conversation
    function selectConversation(conversationId) {
      // Update active state in sidebar
      document.querySelectorAll('.conversation-item').forEach(item => {
        item.classList.remove('active');
        if (item.dataset.id === conversationId) {
          item.classList.add('active');
        }
      });

      // Find the conversation
      const conversation = conversations.find(c => c.id === conversationId);
      if (!conversation) return;

      activeConversation = conversationId;

      // Update chat header
      const chatUserInfo = document.getElementById('currentChatUser');
      chatUserInfo.innerHTML = `
        <div class="chat-user-avatar">${conversation.avatar}</div>
        <div class="chat-user-details">
          <h3>${conversation.name}</h3>
          <p>
            <span class="online-status" style="background: ${conversation.online ? '#4CAF50' : '#999'}"></span>
            ${conversation.online ? 'Online' : 'Offline'} • ${conversation.subject}
          </p>
        </div>
      `;

      // Show chat area
      document.getElementById('chatArea').classList.add('active');

      // Load messages
      loadMessages(conversationId);

      // Clear unread badge for this conversation
      clearUnread(conversationId);

      // Focus on message input
      setTimeout(() => {
        document.getElementById('messageInput').focus();
      }, 100);
    }

    // Load messages for a conversation
    async function loadMessages(conversationId) {
      const messagesContainer = document.getElementById('messagesContainer');
      const currentUserId = localStorage.getItem('skillSwapUserId');
      if (!currentUserId) return;

      const otherUserId = conversationId.replace('real_', '');

      try {
        const response = await fetch(`/api/messages/${currentUserId}/${otherUserId}`);
        if (response.ok) {
          const messages = await response.json();

          // Optimization: Only re-render if the number of messages changed
          const currentDisplayCount = messagesContainer.querySelectorAll('.message').length;
          if (messages.length === currentDisplayCount) return;

          messagesContainer.innerHTML = '<div class="message-date">Today</div>';
          messages.forEach(msg => {
            const messageElement = document.createElement('div');
            const isSent = msg.sender_id == currentUserId;
            messageElement.className = `message ${isSent ? 'sent' : 'received'}`;
            const time = new Date(msg.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            messageElement.innerHTML = `
              <div class="message-content">${msg.content}</div>
              <div class="message-time">${time}</div>
            `;
            messagesContainer.appendChild(messageElement);
          });
          messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
      } catch (e) {
        console.error('Error loading messages:', e);
      }
    }

    // Send a message
    async function sendMessage() {
      const messageInput = document.getElementById('messageInput');
      const messageText = messageInput.value.trim();

      if (!messageText || !activeConversation) return;

      const currentUserId = localStorage.getItem('skillSwapUserId');
      if (!currentUserId) {
        alert('Please log in to send messages');
        return;
      }

      // Extract numeric ID (remove 'real_' prefix if present)
      const receiverId = activeConversation.replace('real_', '');

      // Add message to UI immediately
      const messagesContainer = document.getElementById('messagesContainer');
      const messageElement = document.createElement('div');
      messageElement.className = 'message sent';
      messageElement.innerHTML = `
        <div class="message-content">${messageText}</div>
        <div class="message-time">Just now</div>
      `;
      messagesContainer.appendChild(messageElement);

      // Clear input
      messageInput.value = '';

      // Scroll to bottom
      messagesContainer.scrollTop = messagesContainer.scrollHeight;

      // Save to database
      try {
        const response = await fetch('/api/messages', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            senderId: currentUserId,
            receiverId: receiverId,
            content: messageText
          })
        });

        if (!response.ok) {
          console.error('Failed to save message to database');
        }
      } catch (e) {
        console.error('Error sending message:', e);
      }

      // Update conversation preview
      updateConversationPreview(activeConversation, messageText);
    }

    // Handle Enter key press
    function handleKeyPress(event) {
      if (event.key === 'Enter' && !event.shiftKey) {
        event.preventDefault();
        sendMessage();
      }
    }

    // Update conversation preview in sidebar
    function updateConversationPreview(conversationId, lastMessage) {
      const conversationItem = document.querySelector(`.conversation-item[data-id="${conversationId}"]`);
      if (conversationItem) {
        const preview = conversationItem.querySelector('.conversation-preview');
        const time = conversationItem.querySelector('.conversation-time');

        preview.textContent = lastMessage;
        time.textContent = 'Just now';

        // Move to top
        const list = conversationItem.parentNode;
        list.insertBefore(conversationItem, list.firstChild);
      }
    }

    // Clear unread messages for a conversation
    function clearUnread(conversationId) {
      const conversation = conversations.find(c => c.id === conversationId);
      if (conversation) {
        conversation.unread = 0;
      }

      const badge = document.querySelector(`.conversation-item[data-id="${conversationId}"] .unread-badge`);
      if (badge) {
        badge.remove();
      }
    }

    // New Message Function
    function newMessage() {
      alert('Opening new message dialog...\n\nIn a real app, this would open a dialog to select a user and start a new conversation.');
      // In a real app, implement a modal or new page for starting a conversation
    }

    // Initialize everything on load
    document.addEventListener('DOMContentLoaded', async function () {
      // Set user info
      const username = localStorage.getItem('skillSwapUsername') || 'User';
      document.getElementById('userName').textContent = username;
      const userAvatar = document.getElementById('userAvatar');
      if (username) {
        userAvatar.textContent = username.charAt(0).toUpperCase();
      }

      // Check for incoming chat requested from Learn
      checkForIncomingChat();

      // Load initial conversations (await the async function)
      await loadConversations();

      // Auto-select conversation
      if (activeConversation) {
        selectConversation(activeConversation);
      } else if (window.innerWidth > 768 && conversations.length > 0) {
        selectConversation(conversations[0].id);
      }

      // Add event listener for message input Enter key
      document.getElementById('messageInput').addEventListener('keypress', function (e) {
        if (e.key === 'Enter') {
          sendMessage();
        }
      });

      // --- ADD POLLING FOR REAL-TIME UPDATES ---
      setInterval(async () => {
        // Refresh conversations in background
        await loadConversations(false); // Pass false to avoid full re-render if nothing changed

        // If we are in a real chat, refresh messages
        if (activeConversation && activeConversation.startsWith('real_')) {
          const messagesContainer = document.getElementById('messagesContainer');
          const currentCount = messagesContainer.querySelectorAll('.message').length;

          await loadMessages(activeConversation);

          // If we got new messages, scroll to bottom
          const newCount = messagesContainer.querySelectorAll('.message').length;
          if (newCount > currentCount) {
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
          }
        }
      }, 3000); // Check every 3 seconds
    });

    // Check for incoming chat request
    function checkForIncomingChat() {
      try {
        const incoming = JSON.parse(localStorage.getItem('currentChatUser'));

        if (incoming && incoming.type === 'real') {
          // Ensure IDs are strings for consistency
          const incomingId = incoming.id.toString();

          // Check if already in list
          const exists = conversations.find(c => c.id == incomingId);

          if (!exists) {
            // Add new conversation
            const newConv = {
              id: incomingId,
              name: incoming.name,
              avatar: incoming.avatar || incoming.name.charAt(0).toUpperCase(),
              lastMessage: incoming.lastMessage || 'New Connection',
              time: 'Now',
              unread: 0,
              online: true,
              subject: 'Community Member'
            };
            conversations.unshift(newConv);

            // Initialize empty message history for this user
            if (!messagesData[incomingId]) {
              messagesData[incomingId] = []; // Start with empty chat - no auto messages
            }
          }

          // Set as active to be selected immediately
          activeConversation = incomingId;

          // Clear the request so it doesn't persist forever on reload
          localStorage.removeItem('currentChatUser');
        }
      } catch (e) {
        console.error("Error checking incoming chat", e);
      }
    }

    // Video Call Function - UPDATED: Redirects to videocall.html
    function videoCall() {
      if (!activeConversation) {
        alert('Please select a conversation first.');
        return;
      }

      const conversation = conversations.find(c => c.id == activeConversation);
      if (conversation) {
        localStorage.setItem('videoCallWith', conversation.name);
        localStorage.setItem('videoCallSubject', conversation.subject);
        localStorage.setItem('videoCallAvatar', conversation.avatar);
        window.location.href = 'videocall.html';
      }
    }

    // Audio Call Function
    function audioCall() {
      if (!activeConversation) {
        alert('Please select a conversation first.');
        return;
      }
      alert(`Starting audio call with ${conversations.find(c => c.id === activeConversation).name}...`);
      // In a real app, this would initiate an audio call
    }

    // View Profile Function
    function viewProfile() {
      if (!activeConversation) {
        alert('Please select a conversation first.');
        return;
      }
      const user = conversations.find(c => c.id === activeConversation);
      alert(`Viewing profile of ${user.name}\n\nSubject: ${user.subject}\nStatus: ${user.online ? 'Online' : 'Offline'}`);
      // In a real app, this would open the user's profile page
    }

    // Attach File Function
    function attachFile() {
      alert('File attachment dialog would open here.\n\nSupported: Images, PDFs, Documents (max 10MB)');
      // In a real app, this would open a file picker
    }

    // Go back to dashboard
    function goBack() {
      window.location.href = 'dashboard2.html';
    }


  </script>
</body>

</html>